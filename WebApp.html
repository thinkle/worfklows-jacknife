<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <script src="https://unpkg.com/vue/dist/vue.js"></script> <!-- vue -->
  <script src="https://apis.google.com/js/platform.js"></script> <!-- gapi -->
  <script><?!=exportGlobals();?></script>
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css"> <!-- add-ons styles -->
  <style><?!=include( 'WebApp.css'); ?></style> <!-- style -->
</head>

<body>
  <!-- Simple Sidebar -->
  <div id="appName">
    <h1>Workflows Jacknife</h1>
    <span class="error" v-if="error">{{error}}</span>
    <h2>Installed Workflows (with Triggers)</h2>
    <collapser show-label="Show workflows w/ triggers set up">
    <div v-for="formList,master in masters">
      Master Sheet: <drive-file :id="master"></drive-file>
      <collapser show-label="Show forms" hide-label="Hide forms">Forms: <li v-for="form in formList"><drive-file :id="form"></drive-file></li></collapser>
      <collapser show-label="Show Full Config" hide-label="Hide">
	<div>Config Sheet: <picker api-info="apiInfo" v-model="master"></picker>
	<master-config :config-sheet="master"
		       :api-info="apiInfo"
		       :ref="master">
	</master-config></div>
      </collapser>
    </div>
    </collapser>


    <h2>Non-Active/New Workflows</h2>
    <i>Or workflows w/ triggers under another account</i>
    <collapser>
      <div>
	Config Sheet: <picker type="sheet" :api-info="apiInfo" v-model="configSheet"></picker>
	  <master-config
	    :config-sheet="configSheet"
	    :api-info="apiInfo"
	    ref="master"
	    >
	  </master-config>
      </div>
    </collapser>
  </div>
</body>

<script type="text/x-template" id="picker-template">
  <div class="picker">
    <span v-if="error">{{error}}</span>
    <span v-if="value">
      FILE: <drive-file :id="value">
      </drive-file>
    </span>
    <span>
      <span v-if="!apiInfo.pickerApiLoaded">Loading API...</span>
      <span v-if="!apiInfo.authToken">Loading Authorization token...</span>
      <!-- picker button -->
      <span v-if="apiInfo.pickerApiLoaded&&apiInfo.authToken">
	<button v-if="type=='form'" v-on:click="getForm()">
	  <span v-if="value">Change</span>
	  <span v-else>Select</span>
	  Form
	</button>
	<button v-else v-on:click="getSheet()" >
	  <span v-if="value">Change</span><span v-else>Select</span> Sheet
	</button>
      </span>
    </span>
  </div>
</script>


<script type="text/x-template" id="drive-file">
  <div>
    <div v-if="error" class="error">{{error}}</div>
    <div v-if="id&&!file.id">Loading file data... ({{id}})</div>
    <div v-else-if="id">
      <a :href="file.url" target="_BLANK">{{file.name}}</a>
    </div>
  </div>
</script>

<script type="text/x-template" id="collapser">
  <div>
    <div v-on:click="show=!show">{{label||show&&(hideLabel||'Hide')||(showLabel||'Show')}}</div>
    <div v-if="show">
      <slot></slot>
    </div>
  </div>
</script>

<script type="text/x-template" id="debug">
  <span>
    <span class="debug" v-on:click="show = !show">(d)</span>
    <span v-if="show">
      <slot>
      </slot>
    </span>
  </span>
</script>

<script type="text/x-template" id="master-config">
  <div class="master">
    <!-- Master Sheet: -->
    <div class="error" v-if="error">{{error}}</div>
    <div class="menu" v-if="master.config">
      <button v-on:click="setupTriggers()">Set Up Triggers for Workflow</button>
      <span v-if="!duplicate.config">
	<span v-if="!duplicating">
	  <button v-on:click="duplicateWorkflow">Make a Copy of Workflow</button>
	</span>
	<button v-on:click="gatherDocs">Gather documents into a folder</button> 
      </span>
    </div>
    <div v-if="duplicate.config">
      Duplication results:
      Config: <drive-file :id="duplicate.config"></drive-file>
      <br>Folder: <drive-file :id="duplicate.folder"></drive-file>
    </div>
    <div v-if="folder">
      Gathered documents in folder: <drive-file :id="folder"></drive-file>
    </div>

    <div v-for="configRow,i in master.config">
      <div v-if="i>0">
	<drive-file :id="configRow.Form"></drive-file> {{configRow.Action}}:
	<!-- (get action details <button v-on:click="getAction(configRow.Action,configRow.Form)">GetAction</button> 
	     <div v-if="details">{{details}}</div> -->
	  <span v-for="n in 3">
	    <config-sheet :ref="'config'+n" v-if="configRow['ConfigId'+n]"
			  :n="n"
			  :sheet-id="configRow['ConfigId'+n]"
			  :ss-id="configSheet"
			  :form="configRow.Form"
			  :action="configRow.Action"
			  :raw-config="configRow['Config'+n]"
			  :upstream-forms="configRow.upstreamForms"
			  :href="configRow['ConfigLink'+n]">Config {{n}}</config-sheet>
	  </span>
      </div>
    </div>
    
    <div v-if="master.actions">
      NEW ACTION?
      <span v-for="form in master.config"><button v-if="form.Form" type="checkbox" v-on:click="selectedForm=form.Form">Use {{form.Title}}</button></span>
      <button v-on:click="selectedForm=''">Pick other form:</button>
      <span v-if="!selectedForm"><picker type="form" :api-info="apiInfo" v-on:picked="setForm"></picker> <span v-if="selectedForm">{{selectedForm}}</span></span>
      
      <select v-model="selectedAction">
	<option  v-for="action in master.actions" :value="action">{{action.action}}</option>
      </select>
      <button v-if="selectedForm" v-on:click="getActionDetails">Go</button>
      <div v-if="actionParameters">
	<debug>{{actionParameters}}</debug>
	<table>
	  <tr v-for="param in actionParameters.params">
	    <td>{{param.label}}</td>
	    <td><field-config :formfields="param.fields" v-model="actionConfig[param.field]" :type="param.type" ref="fc"></field-config></td>
	  </tr>
	</table>
	<button v-on:click="createAction">Set up action</button>
      </div>
    </div>
  </div>
</script>



<script type="text/x-template" id="config-sheet">
  <div>
    <span v-if="saved">SAVED</span><span v-else>UNSAVED</span> <button v-on:click="save">Save Changes</button>
    <button v-on:click="show=!show">Config {{n}}</button>
    <div v-if="show">
      <debug><p>CONFIG SHEET {{sheetId}}</p></debug>
      <div v-if="error" class="error">{{error}}</div>
      <debug>{{config}}</debug>
      <table v-if="config">
	<tr v-for="key in config.fields">
	  <td>
	    <span v-if="fieldLookup[key]">{{fieldLookup[key].label}} <debug>{{fieldLookup[key]}}</debug></span>
	    <span v-else>{{key}}</span>
	  </td>
	  <td>
	    <span v-if="fieldLookup[key]">
	      <field-config v-model="config.raw[key]"
			    :type="fieldLookup[key]&&fieldLookup[key].type||key.indexOf('Body')>-1&&5||6"
			    :formfields="details.formFields"
			    :formfieldoptions="details.formFieldOptions"
			    :lookups="config.lookups"
			    :ref="'fl_'+key"
			    :form="form"
			    >
	      </field-config> <!-- use fields for everything -->
	    </span>
	    <span v-else> <!--<input v-model="config.raw[key]">-->
	      <field-config v-model="config.raw[key]"
			    :type="key.indexOf('Body')>-1&&5||6"
			    :formfields="details.formFields"
			    :formfieldoptions="details.formFieldOptions"
			    :lookups="config.lookups"
			    :ref="'fl_'+key"
			    :form="form"
			    >
	      </field-config> <!-- use fields for everything -->
	    </span>
	  </td>
	</tr>
      </table>
      <div v-else>
	Loading data...
      </div>
    </div>
  </div>
</script>

<script type="text/x-template" id="field-config">
  <span>
    <debug>VAL: {{value}}</debug>
    <span v-if="type==1"><!--text-->
      <input type="text" :value="value" @input="updateVal">
    </span>
    <span v-else-if="type==2"> <!--folder-->
      Folder {{value}} (not yet implemented)
    </span>
    <span v-else-if="type==5"> <!-- PARA -->
      <textarea cols="72" rows="10" :value="value" @input="updateVal">
      </textarea>
      <button v-if="!gettingTable" v-on:click="insertFormTable()">Insert Table of Form Values</button><span v-if="gettingTable">Fetching form data...</span>
      </button>
    </span>
    <span v-else-if="type==6">
      <select v-model="mode">
	<option value="raw" default>Enter value</option>
	<option value="field">Choose field</option>
	<option value="lookup">Field lookup</option>
	<option value="magic">Magic field</option>
      </select>
      <span v-if="mode=='field'">
	<select v-model="field"> <!-- @input="updateField">-->
	  <option v-for="f in formfields" :value="f">{{f}}</option>
	</select>
      </span>
      <span v-else-if="mode=='lookup'">
	<select v-model="lookupField">
	  <option v-for="f in formfields" :value="f">{{f}}</option>
	</select>
	<select v-model="lookupDict">
	  <option v-for="dict,name in lookups" :value="name">{{name}}</option>
	  <option value="MAKE_NEW">Create New Lookup</option>
	</select>
	<span v-on:click="showLookup=!showLookup"><span v-if="showLookup">Hide</span><span v-else>Show</span> Lookup Table</span>
	<span v-if="lookupDict && showLookup">
	  <span v-if="lookupDict!='MAKE_NEW'">
	    <table>
	      <tr v-for="val,key in lookups[lookupDict]" v-if="key">
		<td>{{key}}</td>
		<td v-if="formfieldoptions[lookupField]">
		  <span v-if="formfieldoptions[lookupField].indexOf(key)>-1">
		    In form!
		  </span>
		  <span v-else>
		    ?
		  </span>
		</td>
		<td><input v-model="val"></td>
	      </tr>
	      <tr v-if="!lookups[lookupDict].Default"><td>Default</td><td><input v-model="lookups[lookupDict]['Default']"></td>
	      </tr>
	      <tr>
		<td>
		  <span v-if="formfieldoptions[lookupField]">
		    <select v-model="newLookupKey">
		      <option v-for="key in formfieldoptions[lookupField]" v-if="!lookups[lookupDict][key]" :value="key">{{key}}</option>
		    </select>
		  </span>
		  <input v-model="newLookupKey">
		</td>


		<td><input v-model="newLookupVal"><button v-on:click="addLookupKey()">+</button></td>
	      </tr>
	    </table>
	  </span>
	  <span v-else>
	    Lookup Name: <input v-model="newLookupDictName"> <button v-on:click="makeNewLookupDict()">Create</button>
	  </span>
	</span>
      </span>
      <span v-else="mode=='raw'">
	<input type="text" :value="value" @input="updateVal">
      </span>
    </span>
    <span v-else-if="type==8">
      <input type="checkbox" :value="value" @input="updateVal">
    </span>
    
  </span>
</script>


</html>
<script>
<?!=include( 'WebApp.js'); ?>
</script>
