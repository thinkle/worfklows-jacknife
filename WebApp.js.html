// Component

Vue.component('field-config',{
    name : 'field-config',
    props : ['type','value','formfields','lookups'],
    data : function () {return {mode:'field',field:'',
				lookupField:'',lookupDict:'',
				newLookupKey:'',newLookupVal:'',
			       }},
    methods : {
	updateVal : function (event) {
	    console.log('updateVal %s',event.target.value);
	    this.$emit('input',event.target.value);
	},
	setVal : function (v) {
	    console.log('Set value: %s',v);
	    //this.value = v;
	    this.$emit('input',v);
	},
	updateField : function () {
	    console.log('updateField');
	    if (this.mode=='field' && this.field) {
		this.setVal('%'+this.field);
	    }
	},
	updateForVal : function () {
	     console.log('Watched field config with value %s',this.value);
	     if (this.value && this.type==globals.FIELD) {
		 this.mode = 'raw';
		 if (this.value[0]=='%') {
		     this.mode = 'field'
		     this.field = this.value.substr(1)
		 }
		 else if (this.value[0]=='@') {
		     this.mode = 'lookup'
		     var vals = this.value.substr(1).split('>>')
		     this.lookupField = vals[0].trim();
		     this.lookupDict = vals[1].trim();
		 }
		 else if (this.value.substr(0,3)=='*#*') {
		     this.mode == 'magic'
		 }
	     }
	},

	addLookupKey : function () {
	    Vue.set(this.lookups[this.lookupDict],this.newLookupKey,this.newLookupVal);
	    this.newLookupKey = ''; this.newLookupVal = '';
	    this.$forceUpdate()
	}
	
    },
    created : function () {this.updateForVal()
    },
     watch : {
     	field : function (v) {
     	    console.log('field watcher triggered!');
     	    if (this.mode=='field') {
     		console.log('Field updated: %s',v);
     		this.setVal('%'+v);
     	    }
     	},
	 value : function (v) {this.updateForVal()},
     },
    template:'#field-config',
    


});

Vue.component('picker', {
    name : 'picker',
    props : ['apiInfo','type'],
    data : function () {
	return {
	    DEVELOPER_KEY : 'AIzaSyATrC5XEstMsIKMB2ExJ7EoHdPeuF0jvFs',
	    DIALOG_DIMENSIONS : {width: 790, height: 525},
	    error:'',
	}
    },
    methods : {

	getForm : function () {
	    this.getFile(google.picker.ViewId.FORMS)
	},

	getSheet : function () {
	    this.getFile(google.picker.ViewId.SPREADSHEETS)
	},

	getFile : function (viewId) {
	    var self = this;
	    if (self.apiInfo.pickerApiLoaded && self.apiInfo.authToken) {
		var picker = new google.picker.PickerBuilder()
		    .addView(viewId)
		    .enableFeature(google.picker.Feature.NAV_HIDDEN)
		// Hide the title bar since an Apps Script dialog already has a title.
		    //.hideTitleBar()
		    .setOAuthToken(self.apiInfo.authToken)
		    .setDeveloperKey(self.DEVELOPER_KEY)
		    .setCallback(self.gotFileCallback)
		    .setOrigin(google.script.host.origin)
		// Instruct Picker to fill the dialog, minus 2 pixels for the border.
		    .setSize(self.DIALOG_DIMENSIONS.width - 2,
			     self.DIALOG_DIMENSIONS.height - 2)
		    .build();
		picker.setVisible(true);
      } else {
          showError('Unable to load the file picker.');
      }
	}, // end getFile

	gotFileCallback : function (data) {
	    var self = this;
	    var action = data[google.picker.Response.ACTION];
	    if (action == google.picker.Action.PICKED) {
		var doc = data[google.picker.Response.DOCUMENTS][0];
		var docInfo = {doc : doc,
			       id : doc[google.picker.Document.ID],
			       url : doc[google.picker.Document.URL],
			       title : doc[google.picker.Document.NAME]
			      }
		console.log('Got file: %s',JSON.stringify(docInfo));
		self.$emit('picked', docInfo)
	    } else if (action == google.picker.Action.CANCEL) {
		document.getElementById('result').innerHTML = 'Picker canceled.';
		console.log('Canceled');
		self.$emit('canceled');
	    }
      	},
	
    }, // end methods
    template: '#picker-template',
});

Vue.component('config-sheet',{
    name:'config-sheet',
    template:'#config-sheet',
    props : ['sheetId','ssId','n','form','action'],
    created: function () {this.loadData()},
    data : function () {return {
	config:undefined,
	error:'',
	show:false,
	details:undefined,
	saved:true,
	fieldLookup:{}}},
    methods : {
	loadData : function () {
	    var self = this;
	    this.getActionDetails();
	    google.script.run
		.withSuccessHandler(function (data) {
		    self.config = {raw:data}
		    // Now let's do some parsing...
		    self.config.lookups = {}
		    self.config.fields = []
		    for (var key in data) {
			var val = data[key];
			if (key.length>3&&key.indexOf('Key')==key.length-3) { // If it ends in key...
			    // then let's assume there is also a 'Val'
			    var lookupName = key.substr(0,key.length-3)
			    var lookup = {};
			    console.log('Making a lookup from %s,%s',key,val);
			    self.config.lookups[lookupName] = lookup;
			    var lookupKeys = val;
			    var lookupVals = data[lookupName+'Val']
			    console.log('Looking at values: %s',lookupVals);
			    lookupKeys.forEach(function (lookupKey,i) {
				// Loop through lookup keys and create
				lookup[lookupKey] = lookupVals[i]
			    })
			    self.config.lookups[lookupName]=lookup;
			}
			else if (key.length>3&&key.indexOf('Val')==key.length-3) {
			    console.log('Skip val - part of lookup');
			}
			else if (key) {
			    self.config.fields.push(key);
			}
		    }


		})
		.withFailureHandler (function (e) {
		    self.error = e;
		})
		.getConfigTable(
		    self.ssId,
		    self.sheetId
		);
	},

	save : function () {
	    var self = this;
	    google.script.run
		.withSuccessHandler(
		    function (d) {
			self.saved = true;
		    })
		.withFailureHandler(
		    function (e) {
			self.error = e;
		    })
		.updateConfigurationSheet(
		    self.ssId,
		    self.sheetId,
		    self.config.raw,
		    self.lookups
		);
	},

	getActionDetails : function () {
	    var self = this;
	    google.script.run
		.withSuccessHandler(function (d) {
		    self.details = d
		    self.fieldLookup = {}
		    self.details.params.forEach(function (p) {
			self.fieldLookup[p.field]=p
		    });
		})
	        .withFailureHandler(function (e) {self.error = e})
		.getActionDetails(this.action,this.form)
	},
    }, // end methods
    watch : {
	lookups : {deep: true,
		   handler : function (v) {this.saved = false}},
	'config.raw' : {deep:true,
		      handler : function (v) {this.saved = false}}
    },
}) // end config-sheet component

Vue.component('debug',{
    name:'debug',
    template:'#debug',
    data : function () {return {show:false}}
})

Vue.component('master-config',{
    name:'master-config',
    template : '#master-config',
    props:['configSheet','apiInfo'],
    data : function () {
	return {
	    expand : false,
	    error : '',
	    master : {},
	    details : false,
	    selectedForm : false,
	    selectedAction : undefined,
	    actionParameters : undefined,
	    actionConfig : {},
	}
    },
    created : function () {this.loadData()},
    methods : 	{
	loadData : function () {
	    var self = this;
	    //var ID = '13J7v8UvtHFB0L7k0qJrDPIuZHRMaT01Ayas47jxion8'
	    console.log("Loading ID %s",this.configSheet);
	    google.script.run
		.withSuccessHandler(function (data) {
		    console.log('Got data: %s',JSON.stringify(data));
		    self.master = data;
		    console.log('Populated master with data');
		})
		.withFailureHandler(function (e) {
		    console.log('Got error : %s',e);
		    self.error = e
		})
		.getCurrentMasterConfig(this.configSheet);
	},

	getAction : function (action, form) {
	    var self = this;
	    console.log('Getting action: %s',action);
	    google.script.run
		.withSuccessHandler(function (data) {
		    self.details = data;
		})
		.withFailureHandler(function (error) {
		    self.error = error;
		})
		.getActionDetails(action,form)
	},

	setForm : function (form) {
	    var self = this;
	    console.log('Got a form %s',form);
	    self.selectedForm = form;
	},


	getActionDetails : function () {
	    var self = this;
	    google.script.run
	        .withFailureHandler(function (e) {self.error = e})
		.withSuccessHandler(function (parameters) {
		    self.actionConfig['SpreadsheetApp'] = self.configSheet;
		    self.actionParameters = parameters;
		    self.actionParameters.params.forEach(function (p) {
			if (p.val) {
			    self.actionConfig[p.field]=p.val;
			}
		    })
		})
		.getActionDetails(self.selectedAction.action,self.selectedForm.doc.url)
	},

	createAction : function () {
	    var self = this;
	    console.log('Creating action! %s %s',self.selectedAction.action,self.selectedForm);
	    var self = this;
	    google.script.run.sidebarDoAction(self.selectedAction.action,self.selectedForm.doc.url,self.actionConfig);
	},

    }
});

JacknifeApp = new Vue({
    el : '#appName',
    data : {
	'test':'Not a field - should be raw :)',
	error:'',
	configSheet : '',
	chosenSheet : '',
	apiInfo: {pickerApiLoaded:false,authToken:undefined}},
    
    methods : {


	// CALLBACKS
	setConfig : function (form) {
	    console.log('Got form info: %s',form);
	    this.chosenSheet = form;
	    this.configSheet = form.doc.id;
	},

	gotSheet : function (sheet) {
	    this.sheet = sheet;
	    console.log('Got sheet info: %s',sheet);
	},

	// PICKER API CALLS...
	loadApi : function () {
	    var self = this;
	    gapi.load('picker',{'callback':function () {
		self.apiInfo.pickerApiLoaded = true;
	    }});
	},
	getOAuthToken : function () {
	    var self = this;
	    google.script.run.withSuccessHandler(
		function (token) {self.apiInfo.authToken = token}
	    )
		.withFailureHandler(function (e) {self.error = e}).getOAuthToken();
	},

	loadPickerApi : function () {
	    this.loadApi()
	    this.getOAuthToken()
	}
    }, // end methods

    created : function () {
	this.loadPickerApi()
    },
    


});

// Handle URL parameters
google.script.url.getLocation(
    function (l) {
	if (l.parameter.doc) {
	    console.log('Got config in URL: %s',l.parameter.doc)
	    //var master = JacknifeApp.$refs.master;
	    //master.configSheet = l.parameter.doc
	    //master.loadData();
	    JacknifeApp.configSheet = l.parameter.doc;

	}
    }
); // end getLocation callback

//JacknifeApp.loadData()
